<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Exercise Tracker</title>
  <link rel="apple-touch-icon" sizes="180x180" href="./favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicons/favicon-16x16.png">
  <link rel="manifest" href="./favicons/site.webmanifest">
  <link rel="mask-icon" href="./favicons/safari-pinned-tab.svg" color="#56d364">
  <meta name="msapplication-TileColor" content="#0e0f13">
  <meta name="theme-color" content="#0e0f13">

  <!-- Open graph meta tags -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Exercise Tracker & Counter">
  <meta property="og:url" content="https://polarity.productions/pushups/">
  <meta property="og:image" content="https://polarity.productions/pushups/assets/Pushups.jpg">
  <meta property="og:description" content="Track your daily exercises with your smartphone camera. No login, no subscription, no hidden costs, no ads, and secure local data storage in your browser. Open source and free forever! Use online or download for your own server.">

  <style>
    :root {
      --bg: #0e0f13;
      --panel: #151822;
      --text: #e6e6e6;
      --muted: #a0a4b8;
      --accent: #56d364;
      --danger: #ff6b6b;
      --warn: #f7b500;
      --border: #222536;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Cantarell, Noto Sans, Ubuntu, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 20px 16px 0;
      text-align: center;
    }

    header h1 {
      margin: 0 0 4px 0;
      font-weight: 700;
      font-size: 22px;
      letter-spacing: 0.3px;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: 13px
    }

    main {
      padding: 12px 16px 28px;
      max-width: 780px;
      margin: 0 auto
    }

    /* Added exercise selector styles */
    .exercise-selector {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .exercise-selector label {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
    }

    .exercise-selector select {
      flex: 1;
      min-width: 150px;
      background: #1a1f2d;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .exercise-selector select:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .exercise-selector button {
      padding: 10px 16px;
      font-size: 14px;
      background: #18311f;
      border-color: #23452a;
      color: var(--accent);
    }
    /* </CHANGE> */

    /* Added sensitivity slider styles */
    .sensitivity-control {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .sensitivity-control label {
      font-weight: 600;
      font-size: 14px;
      color: var(--muted);
      white-space: nowrap;
    }

    .sensitivity-control input[type="range"] {
      flex: 1;
      min-width: 150px;
      height: 6px;
      border-radius: 3px;
      background: #1a1f2d;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .sensitivity-control input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: 2px solid var(--bg);
    }

    .sensitivity-control input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      border: 2px solid var(--bg);
    }

    .sensitivity-control .value-display {
      font-weight: 700;
      font-size: 14px;
      color: var(--text);
      min-width: 45px;
      text-align: right;
    }
    /* </CHANGE> */

    .counter-panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .count {
      display: flex;
      align-items: baseline;
      gap: 12px;
      justify-content: center;
    }

    .count .value {
      font-size: 72px;
      font-weight: 800;
      line-height: 1
    }

    .count .unit {
      color: var(--muted)
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .sessions {
      background: #12151f;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px 8px;
      font-size: 13px;
      display: grid;
      gap: 6px;
    }

    .sessions-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }

    .sessions-header button {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 6px;
      font-weight: 600
    }

    .sessions-actions {
      display: flex;
      gap: 6px;
    }

    .sessions-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 4px;
      max-height: 150px;
      overflow-y: auto
    }

    .session-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #1a1f2d;
      border: 1px solid #202636;
      padding: 6px 8px;
      border-radius: 6px;
    }

    .session-item.active {
      border-color: #21422a;
      background: #17241b
    }

    .session-label {
      font-weight: 600;
      color: var(--muted);
      width: 48px
    }

    .session-count {
      font-weight: 700;
      font-size: 14px;
      flex: 1;
      text-align: right
    }

    .session-item button.del {
      background: #311818;
      border-color: #452323;
      color: var(--danger);
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
    }

    .session-item button.del:active {
      transform: none
    }

    .session-item button.del:hover {
      background: #3a2020
    }

    button {
      -webkit-tap-highlight-color: transparent;
      background: #1a1f2d;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed
    }

    button:active {
      transform: translateY(1px)
    }

    .btn-plus {
      background: #18311f;
      border-color: #23452a;
      color: var(--accent)
    }

    .btn-minus {
      background: #311818;
      border-color: #452323;
      color: var(--danger)
    }

    .btn-reset {
      background: #2b220f;
      border-color: #3a2f16;
      color: var(--warn)
    }

    .video-wrap {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: center;
    }

    .video-box {
      position: relative;
      width: 140px;
      height: 180px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #000;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover
    }

    canvas.overlay {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none
    }

    .status {
      display: grid;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    .status .chip {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #171b26;
      color: var(--text);
      font-weight: 600
    }

    .status .ok {
      color: var(--accent);
      border-color: #21422a;
      background: #142018
    }

    .status .warn {
      color: var(--warn);
      border-color: #3a2f16;
      background: #231b0b
    }

    .status .bad {
      color: var(--danger);
      border-color: #452323;
      background: #261313
    }

    section.table {
      margin-top: 16px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    thead th {
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      padding: 10px 12px;
      background: #131622
    }

    tbody td {
      padding: 12px;
      border-top: 1px solid var(--border)
    }

    tbody tr:hover {
      background: #131622
    }

    .td-right {
      text-align: right
    }

    .row {
      display: grid;
      gap: 10px;
    }

    @media (min-width: 700px) {
      .counter-panel {
        grid-template-columns: 1fr
      }

      .video-wrap {
        grid-template-columns: auto 1fr
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Exercise Tracker</h1>
    <p>Put your phone on the floor. Each time your face gets close to the camera, it counts one rep.</p>
  </header>

  <main>
    <!-- Added exercise selector UI -->
    <div class="exercise-selector">
      <label for="exerciseSelect">Exercise:</label>
      <select id="exerciseSelect">
        <option value="pushups">Pushups</option>
        <option value="pullups">Pullups</option>
        <option value="squats">Squats</option>
        <option value="situps">Situps</option>
        <option value="burpees">Burpees</option>
      </select>
      <button id="addExerciseBtn" title="Add custom exercise">+ Add Custom</button>
    </div>
    <!-- </CHANGE> -->

    <!-- Added sensitivity slider control -->
    <div class="sensitivity-control">
      <label for="sensitivitySlider">Camera Sensitivity:</label>
      <input type="range" id="sensitivitySlider" min="0.5" max="2.0" step="0.1" value="1.0">
      <span class="value-display" id="sensitivityValue">1.0x</span>
    </div>
    <!-- </CHANGE> -->

    <div class="counter-panel">
      <div class="count">
        <div id="countVal" class="value">0</div>
        <div class="unit">today</div>
      </div>

      <div class="controls">
        <button id="minusBtn" class="btn-minus" title="Decrease">−</button>
        <button id="plusBtn" class="btn-plus" title="Increase">＋</button>
        <button id="resetBtn" class="btn-reset" title="Reset today">Reset</button>
        <button id="cameraBtn" title="Start/Stop camera">Start Camera</button>
      </div>

      <div class="sessions">
        <div class="sessions-header">
          <span>Sessions Today</span>
          <div class="sessions-actions">
            <button id="newSessionBtn" title="Start a new session">New Session</button>
            <button id="endSessionBtn" title="End the current session">End Session</button>
          </div>
        </div>
        <ul id="sessionsList" class="sessions-list"></ul>
      </div>

      <div class="video-wrap">
        <div class="video-box">
          <video id="video" autoplay muted playsinline></video>
          <canvas id="overlay" class="overlay"></canvas>
        </div>
        <div class="status">
          <div>Detector: <span id="detectorType" class="chip">—</span></div>
          <div>State: <span id="stateChip" class="chip">idle</span></div>
          <div>Hint: if camera doesn't start, open this page over HTTPS or on localhost.</div>
        </div>
      </div>
    </div>

    <section class="table" aria-label="Last 7 days">
      <table>
        <thead>
        <tr>
          <th>Day</th>
          <th>Date</th>
          <th class="td-right">Count</th>
        </tr>
        </thead>
        <tbody id="weekBody"></tbody>
      </table>
    </section>
  </main>

  <script>
  ;(() => {
    const STORE_KEY = 'exercises.v2'
    const EXERCISES_KEY = 'exercises.list'
    const SENSITIVITY_KEY = 'camera.sensitivity'
    let currentExercise = 'pushups'
    let sensitivity = loadSensitivity()
    // </CHANGE>

    // UI elements
    const countEl = document.getElementById('countVal')
    const weekBody = document.getElementById('weekBody')
    const video = document.getElementById('video')
    const overlay = document.getElementById('overlay')
    const detectorTypeEl = document.getElementById('detectorType')
    const stateChip = document.getElementById('stateChip')

    const plusBtn = document.getElementById('plusBtn')
    const minusBtn = document.getElementById('minusBtn')
    const resetBtn = document.getElementById('resetBtn')
    const cameraBtn = document.getElementById('cameraBtn')
    const newSessionBtn = document.getElementById('newSessionBtn')
    const endSessionBtn = document.getElementById('endSessionBtn')
    const sessionsListEl = document.getElementById('sessionsList')
    
    const exerciseSelect = document.getElementById('exerciseSelect')
    const addExerciseBtn = document.getElementById('addExerciseBtn')
    const sensitivitySlider = document.getElementById('sensitivitySlider')
    const sensitivityValue = document.getElementById('sensitivityValue')
    // </CHANGE>

    // App state
    const data = loadData()
    let stream = null
    let activeSessionId = null

    // Counting state
    let countingEnabled = false
    let prevNear = false
    let lastCountTs = 0
    const minIntervalMs = 800 // debounce between reps

    // Detector state
    let useFaceDetector = 'FaceDetector' in window
    let faceDetector = null
    if (useFaceDetector) {
      try {
        faceDetector = new window.FaceDetector({ fastMode: true, maxDetectedFaces: 1 })
      } catch (e) {
        useFaceDetector = false
      }
    }

    // Fallback brightness sampling
    const samp = {
      canvas: document.createElement('canvas'),
      ctx: null,
      w: 160,
      h: 120,
      minL: 255,
      maxL: 0,
      near: false
    }
    samp.ctx = samp.canvas.getContext('2d', { willReadFrequently: true })

    // Thresholds for face size ratio based detection (with hysteresis)
    const NEAR_RATIO = 0.32
    const FAR_RATIO = 0.25
    // </CHANGE> Base thresholds that will be adjusted by sensitivity

    // Camera support detection and polyfill
    const isSecure = (window.location.protocol === 'https:' || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
    const hasModernGUM = !!(navigator.mediaDevices && typeof navigator.mediaDevices.getUserMedia === 'function')
    const legacyGUM = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia

    function anyGetUserMediaAvailable () {
      return hasModernGUM || !!legacyGUM
    }

    function requestUserMedia (constraints) {
      if (hasModernGUM) return navigator.mediaDevices.getUserMedia(constraints)
      if (legacyGUM) {
        return new Promise((resolve, reject) => legacyGUM.call(navigator, constraints, resolve, reject))
      }
      return Promise.reject(new Error('getUserMedia not supported'))
    }

    loadExerciseList()
    updateExerciseSelect()
    sensitivitySlider.value = sensitivity
    sensitivityValue.textContent = sensitivity.toFixed(1) + 'x'
    // </CHANGE>

    // Init UI
    updateCountUI()
    renderWeek()
    detectorTypeEl.textContent = useFaceDetector ? 'FaceDetector API' : 'Brightness (fallback)'
    detectorTypeEl.className = 'chip ' + (useFaceDetector ? 'ok' : 'warn')
    migrateLegacy()
    renderSessions()
    updateCountUI() // refresh after migration
    renderWeek()

    // Configure camera button availability and status hints
    if (!isSecure) {
      cameraBtn.disabled = true
      cameraBtn.textContent = 'Camera Requires HTTPS'
      stateChip.textContent = 'insecure context'
      stateChip.className = 'chip warn'
    } else if (!anyGetUserMediaAvailable()) {
      cameraBtn.disabled = true
      cameraBtn.textContent = 'Camera Unsupported'
      stateChip.textContent = 'unsupported'
      stateChip.className = 'chip bad'
      // iOS Firefox/Chrome may lack getUserMedia in WKWebView; advise user via hint line below
    }

    // Wire buttons
    plusBtn.addEventListener('click', () => modifyToday(1))
    minusBtn.addEventListener('click', () => modifyToday(-1))
    resetBtn.addEventListener('click', () => resetToday())
    cameraBtn.addEventListener('click', () => toggleCamera())
    newSessionBtn.addEventListener('click', () => startNewSession())
    endSessionBtn.addEventListener('click', () => endActiveSession())
    
    exerciseSelect.addEventListener('change', (e) => {
      currentExercise = e.target.value
      activeSessionId = null // Reset active session when switching exercises
      updateCountUI()
      renderSessions()
      renderWeek()
    })

    addExerciseBtn.addEventListener('click', () => {
      const name = window.prompt('Enter custom exercise name:')
      if (name && name.trim()) {
        const exerciseId = name.trim().toLowerCase().replace(/\s+/g, '-')
        addCustomExercise(exerciseId, name.trim())
      }
    })
    // </CHANGE>

    sensitivitySlider.addEventListener('input', (e) => {
      sensitivity = parseFloat(e.target.value)
      sensitivityValue.textContent = sensitivity.toFixed(1) + 'x'
      saveSensitivity()
    })
    // </CHANGE>

    sessionsListEl.addEventListener('click', e => {
      const btn = e.target.closest('button.del')
      if (!btn) return
      const li = btn.closest('li.session-item')
      if (!li) return
      const sid = li.getAttribute('data-id')
      if (window.confirm('Delete this session?')) {
        deleteSession(sid)
      }
    })

    function toggleCamera () {
      if (stream) {
        stopCamera()
        cameraBtn.textContent = 'Start Camera'
        stateChip.textContent = 'idle'
        stateChip.className = 'chip'
      } else {
        startCamera()
      }
    }

    async function startCamera () {
      if (!isSecure) {
        window.alert('Camera requires HTTPS or localhost. Please host the file on https:// or run on http://localhost.')
        return
      }
      if (!anyGetUserMediaAvailable()) {
        window.alert('Camera not supported in this browser. On iOS, use Safari; third-party browsers may have limited camera support.')
        return
      }
      try {
        const constraints = {
          audio: false,
          video: {
            facingMode: 'user',
            width: { ideal: 640 },
            height: { ideal: 480 }
          }
        }
        stream = await requestUserMedia(constraints)
        video.srcObject = stream
        await video.play()
        resizeOverlay()
        countingEnabled = true
        cameraBtn.textContent = 'Stop Camera'
        loop()
      } catch (err) {
        const msg = (err && (err.message || err.name)) ? `${err.name || ''} ${err.message || ''}`.trim() : String(err)
        window.alert('Camera error: ' + msg + '\n\nTip: On iOS, try Safari; ensure you\'re on HTTPS or localhost and you\'ve granted camera permission.')
        stateChip.textContent = 'error'
        stateChip.className = 'chip bad'
      }
    }

    function stopCamera () {
      countingEnabled = false
      prevNear = false
      if (stream) {
        stream.getTracks().forEach(t => t.stop())
        stream = null
      }
    }

    function resizeOverlay () {
      overlay.width = video.videoWidth || 640
      overlay.height = video.videoHeight || 480
    }

    let rafId = 0
    let busy = false

    async function loop () {
      if (!countingEnabled) return

      if (!busy) {
        busy = true
        try {
          if (useFaceDetector) await detectWithFaceDetector()
          else detectWithBrightness()
        } catch (e) {
          // if FaceDetector keeps failing, fallback automatically
          if (useFaceDetector) {
            useFaceDetector = false
            detectorTypeEl.textContent = 'Brightness (fallback)'
            detectorTypeEl.className = 'chip warn'
          }
        } finally {
          busy = false
        }
      }

      rafId = window.requestAnimationFrame(loop)
    }

    async function detectWithFaceDetector () {
      if (!video.videoWidth) return
      const faces = await faceDetector.detect(video)
      const ctx = overlay.getContext('2d')
      ctx.clearRect(0, 0, overlay.width, overlay.height)

      let near = false
      if (faces && faces.length) {
        const f = faces[0]
        const bb = f.boundingBox
        // draw box
        ctx.strokeStyle = 'rgba(86, 211, 100, 0.9)'
        ctx.lineWidth = 3
        ctx.strokeRect(bb.x, bb.y, bb.width, bb.height)

        const ratio = bb.height / (video.videoHeight || 1)
        const adjustedNearRatio = NEAR_RATIO / sensitivity
        const adjustedFarRatio = FAR_RATIO / sensitivity
        near = ratio >= adjustedNearRatio
        if (!near && prevNear && ratio >= adjustedFarRatio) near = true // hysteresis keep-near
        // </CHANGE>
      }

      handleNearState(near)
    }

    function detectWithBrightness () {
      if (!video.videoWidth) return
      const w = samp.w
      const h = samp.h
      samp.canvas.width = w
      samp.canvas.height = h

      samp.ctx.drawImage(video, 0, 0, w, h)

      // sample center region (40% of width/height)
      const cw = Math.floor(w * 0.4)
      const ch = Math.floor(h * 0.4)
      const cx = Math.floor((w - cw) / 2)
      const cy = Math.floor((h - ch) / 2)
      const img = samp.ctx.getImageData(cx, cy, cw, ch)
      let sum = 0
      const dataArr = img.data
      for (let i = 0; i < dataArr.length; i += 4) {
        // luma approximation
        sum += 0.2126 * dataArr[i] + 0.7152 * dataArr[i + 1] + 0.0722 * dataArr[i + 2]
      }
      const avg = sum / (dataArr.length / 4)

      // track min/max with slow adaptation
      samp.minL = Math.min(samp.minL * 0.995 + avg * 0.005, avg)
      samp.maxL = Math.max(samp.maxL * 0.995 + avg * 0.005, avg)

      const span = Math.max(20, samp.maxL - samp.minL) // avoid divide by tiny
      const norm = (avg - samp.minL) / span // 0..1

      // Heuristic: near when darker than threshold; adjust thresholds based on sensitivity
      const nearTh = 0.25 * sensitivity
      const farTh = 0.40 * sensitivity
      let near = norm <= nearTh
      if (!near && prevNear && norm <= farTh) near = true
      // </CHANGE>

      // light overlay indicator
      const ctx = overlay.getContext('2d')
      ctx.clearRect(0, 0, overlay.width, overlay.height)
      ctx.fillStyle = near ? 'rgba(247,181,0,0.15)' : 'rgba(255,255,255,0.06)'
      ctx.fillRect(overlay.width * 0.3, overlay.height * 0.3, overlay.width * 0.4, overlay.height * 0.4)

      handleNearState(near)
    }

    function handleNearState (near) {
      updateStateChip(near)

      const now = Date.now()
      if (near && !prevNear) {
        // edge: far -> near
        if (now - lastCountTs >= minIntervalMs) {
          modifyToday(1)
          lastCountTs = now
        }
      }
      prevNear = near
    }

    function updateStateChip (near) {
      if (!stream) {
        stateChip.textContent = 'idle'
        stateChip.className = 'chip'
        return
      }
      if (near) {
        stateChip.textContent = 'near'
        stateChip.className = 'chip ok'
      } else {
        stateChip.textContent = 'far'
        stateChip.className = 'chip'
      }
    }

    // Data & UI helpers
    function todayKey () {
      const d = new Date()
      const y = d.getFullYear()
      const m = String(d.getMonth() + 1).padStart(2, '0')
      const day = String(d.getDate()).padStart(2, '0')
      return `${y}-${m}-${day}`
    }

    function loadData () {
      try {
        const raw = window.localStorage.getItem(STORE_KEY)
        return raw ? JSON.parse(raw) : {}
      } catch (e) {
        return {}
      }
    }

    function saveData () {
      try {
        window.localStorage.setItem(STORE_KEY, JSON.stringify(data))
      } catch (e) {
        // ignore
      }
    }

    function loadExerciseList () {
      try {
        const raw = window.localStorage.getItem(EXERCISES_KEY)
        if (!raw) {
          // Initialize with default exercises
          const defaults = [
            { id: 'pushups', name: 'Pushups' },
            { id: 'pullups', name: 'Pullups' },
            { id: 'squats', name: 'Squats' },
            { id: 'situps', name: 'Situps' },
            { id: 'burpees', name: 'Burpees' }
          ]
          window.localStorage.setItem(EXERCISES_KEY, JSON.stringify(defaults))
          return defaults
        }
        return JSON.parse(raw)
      } catch (e) {
        return []
      }
    }

    function saveExerciseList (list) {
      try {
        window.localStorage.setItem(EXERCISES_KEY, JSON.stringify(list))
      } catch (e) {
        // ignore
      }
    }

    function addCustomExercise (id, name) {
      const list = loadExerciseList()
      if (list.find(ex => ex.id === id)) {
        window.alert('Exercise already exists!')
        return
      }
      list.push({ id, name })
      saveExerciseList(list)
      updateExerciseSelect()
      exerciseSelect.value = id
      currentExercise = id
      updateCountUI()
      renderSessions()
      renderWeek()
    }

    function updateExerciseSelect () {
      const list = loadExerciseList()
      exerciseSelect.innerHTML = list.map(ex => 
        `<option value="${ex.id}">${ex.name}</option>`
      ).join('')
      exerciseSelect.value = currentExercise
    }

    function getTodayCount () {
      const k = todayKey()
      if (!data[currentExercise]) return 0
      const dayObj = data[currentExercise][k]
      if (dayObj == null) return 0
      if (typeof dayObj === 'number') return dayObj
      if (dayObj && Array.isArray(dayObj.sessions)) return dayObj.sessions.reduce((a, s) => a + (s.count || 0), 0)
      return 0
    }

    function modifyToday (delta) {
      if (!Number.isFinite(delta) || delta === 0) return
      const sess = ensureActiveSession()
      sess.count = Math.max(0, (sess.count || 0) + delta)
      saveTodaySessions()
      updateCountUI()
      renderSessions()
      renderWeek()
    }

    function resetToday () {
      if (!window.confirm('Reset ALL sessions for today?')) return
      const k = todayKey()
      if (!data[currentExercise]) data[currentExercise] = {}
      data[currentExercise][k] = { sessions: [] }
      // </CHANGE>
      activeSessionId = null
      saveData()
      updateCountUI()
      renderSessions()
      renderWeek()
    }

    function updateCountUI () {
      countEl.textContent = String(getTodayCount())
    }

    function renderWeek () {
      const rows = []
      const now = new Date()
      for (let i = 0; i < 7; i++) {
        const d = new Date(now)
        d.setDate(now.getDate() - i)
        const key = dateKey(d)
        const cnt = dayTotal(key)
        rows.push({ d, key, cnt })
      }
      weekBody.innerHTML = rows
        .map(({ d, cnt }) => {
          const day = d.toLocaleDateString(undefined, { weekday: 'short' })
          const date = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })
          return `<tr><td>${day}</td><td>${date}</td><td class="td-right">${cnt}</td></tr>`
        })
        .join('')
    }

    function dateKey (d) {
      const y = d.getFullYear()
      const m = String(d.getMonth() + 1).padStart(2, '0')
      const day = String(d.getDate()).padStart(2, '0')
      return `${y}-${m}-${day}`
    }

    // Handle orientation / metadata ready
    video.addEventListener('loadedmetadata', resizeOverlay)

    // Cleanup on page hide
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopCamera()
    })

    // ----- Sessions Logic -----
    function migrateLegacy () {
      // Check if we need to migrate from old v1 format
      const oldKey = 'pushups.v1'
      try {
        const oldRaw = window.localStorage.getItem(oldKey)
        if (oldRaw) {
          const oldData = JSON.parse(oldRaw)
          // Migrate old pushups data to new structure
          if (!data.pushups) data.pushups = {}
          for (const key in oldData) {
            if (typeof oldData[key] === 'number') {
              data.pushups[key] = { sessions: [legacySession(oldData[key])] }
            } else {
              data.pushups[key] = oldData[key]
            }
          }
          saveData()
          // Remove old key
          window.localStorage.removeItem(oldKey)
        }
      } catch (e) {
        // ignore migration errors
      }

      // Migrate any remaining number values in current structure
      for (const exercise in data) {
        for (const key in data[exercise]) {
          if (typeof data[exercise][key] === 'number') {
            const n = data[exercise][key]
            data[exercise][key] = { sessions: [legacySession(n)] }
          }
        }
      }
      saveData()
    }

    function legacySession (count) {
      const ts = new Date().toISOString()
      return { id: genId(), count: Math.max(0, count || 0), started: ts, ended: ts }
    }

    function ensureDayObj (k) {
      if (!data[currentExercise]) data[currentExercise] = {}
      if (!data[currentExercise][k]) data[currentExercise][k] = { sessions: [] }
      if (!Array.isArray(data[currentExercise][k].sessions)) data[currentExercise][k].sessions = []
      return data[currentExercise][k]
    }

    function ensureActiveSession () {
      const k = todayKey()
      const day = ensureDayObj(k)
      // reuse existing active if still present
      if (activeSessionId) {
        const existing = day.sessions.find(s => s.id === activeSessionId)
        if (existing && !existing.ended) return existing
      }
      // try find any open session
      let open = day.sessions.find(s => !s.ended)
      if (open) {
        activeSessionId = open.id
        return open
      }
      // create new implicit session
      open = { id: genId(), count: 0, started: new Date().toISOString(), ended: null }
      day.sessions.push(open)
      activeSessionId = open.id
      saveTodaySessions()
      renderSessions()
      return open
    }

    function startNewSession () {
      // end existing active
      const k = todayKey()
      const day = ensureDayObj(k)
      if (activeSessionId) {
        const cur = day.sessions.find(s => s.id === activeSessionId)
        if (cur && !cur.ended) cur.ended = new Date().toISOString()
      }
      const sess = { id: genId(), count: 0, started: new Date().toISOString(), ended: null }
      day.sessions.push(sess)
      activeSessionId = sess.id
      saveTodaySessions()
      renderSessions()
    }

    function endActiveSession () {
      const k = todayKey()
      const day = ensureDayObj(k)
      if (activeSessionId) {
        const cur = day.sessions.find(s => s.id === activeSessionId)
        if (cur && !cur.ended) {
          cur.ended = new Date().toISOString()
          saveTodaySessions()
          renderSessions()
        }
      }
    }

    function deleteSession (id) {
      const k = todayKey()
      const day = ensureDayObj(k)
      const idx = day.sessions.findIndex(s => s.id === id)
      if (idx >= 0) day.sessions.splice(idx, 1)
      if (activeSessionId === id) activeSessionId = null
      saveTodaySessions()
      updateCountUI()
      renderSessions()
      renderWeek()
    }

    function dayTotal (k) {
      if (!data[currentExercise]) return 0
      const v = data[currentExercise][k]
      if (v == null) return 0
      if (typeof v === 'number') return v
      if (Array.isArray(v.sessions)) return v.sessions.reduce((a, s) => a + (s.count || 0), 0)
      return 0
    }

    function saveTodaySessions () {
      saveData()
    }

    function renderSessions () {
      const k = todayKey()
      const day = ensureDayObj(k)
      const sessions = day.sessions
      if (!sessions.length) {
        sessionsListEl.innerHTML = '<li class="session-item" style="opacity:.7">No sessions yet</li>'
        return
      }
      sessionsListEl.innerHTML = sessions.map((s, i) => {
        const isActive = !s.ended
        return `<li class="session-item ${isActive ? 'active' : ''}" data-id="${s.id}">` +
            `<span class="session-label">#${i + 1}${isActive ? '*' : ''}</span>` +
            `<span class="session-count">${s.count}</span>` +
            '<button class="del" title="Delete session" aria-label="Delete session">×</button>' +
            '</li>'
      }).join('')
    }

    function genId () {
      return Math.random().toString(36).slice(2, 8) + Date.now().toString(36).slice(-4)
    }

    function loadSensitivity () {
      try {
        const raw = window.localStorage.getItem(SENSITIVITY_KEY)
        return raw ? parseFloat(raw) : 1.0
      } catch (e) {
        return 1.0
      }
    }

    function saveSensitivity () {
      try {
        window.localStorage.setItem(SENSITIVITY_KEY, sensitivity.toString())
      } catch (e) {
        // ignore
      }
    }
    // </CHANGE>
  })()

  </script>
</body>
</html>
